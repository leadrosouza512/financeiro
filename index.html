<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinControl Premium</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. NOVO DESIGN SYSTEM (Estilo "Planner") --- */
        :root {
            /* Cores Principais */
            --primary: #1a73e8; /* Azul Profundo (Google/Planner Blue) */
            --primary-dark: #0d47a1;
            --accent-green: #28a745; /* Verde Sucesso */
            --accent-red: #dc3545; /* Vermelho Despesa */
            
            /* Fundos e Textos */
            --bg-body: #f0f2f5; /* Cinza muito claro para o fundo */
            --bg-card: #ffffff; /* Branco puro para os cart√µes */
            --text-main: #2c3e50; /* Cinza escuro para texto principal */
            --text-muted: #6c757d; /* Cinza m√©dio para textos secund√°rios */
            --border-color: #e9ecef;
            
            /* Efeitos */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08); /* Sombra mais suave e difusa */
            --radius: 16px; /* Bordas mais arredondadas */
        }

        /* Tema Escuro (Adaptado) */
        [data-theme="dark"] {
            --primary: #4dabf7;
            --bg-body: #121212; 
            --bg-card: #1e1e1e; 
            --text-main: #f8f9fa;
            --text-muted: #adb5bd;
            --border-color: #333;
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; transition: 0.3s; }
        
        /* √çcones gen√©ricos */
        .icon { font-size: 1.4rem; margin-right: 10px; }

        /* --- 2. TELA DE LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-card {
            background: var(--bg-card); padding: 50px 40px; border-radius: var(--radius);
            box-shadow: var(--shadow-md); text-align: center; width: 90%; max-width: 420px;
        }
        .btn-google {
            background: #fff; color: #555; border: 1px solid #ddd;
            padding: 15px 20px; border-radius: 12px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 15px; width: 100%; margin-top: 30px;
            transition: 0.2s; font-family: 'Poppins', sans-serif;
        }
        .btn-google:hover { background: #f8f8f8; box-shadow: var(--shadow-sm); }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- 3. LAYOUT APP --- */
        .app-layout { display: flex; height: 100%; display: none; }
        
        /* Sidebar (Menu Lateral) */
        #sidebar {
            width: 280px; background: var(--bg-card); display: flex; flex-direction: column;
            border-right: 1px solid var(--border-color); z-index: 2000; transition: transform 0.3s ease;
        }
        .brand { padding: 30px 25px; font-size: 1.6rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 12px; }
        .menu-list { list-style: none; padding: 0 20px; margin-top: 10px; flex: 1; }
        .menu-link {
            display: flex; align-items: center; padding: 14px 18px; text-decoration: none;
            color: var(--text-muted); border-radius: 12px; font-weight: 500; cursor: pointer; margin-bottom: 8px; transition: 0.2s;
        }
        .menu-link:hover { background: var(--bg-body); color: var(--primary); }
        .menu-link.active { background: rgba(26, 115, 232, 0.1); color: var(--primary); font-weight: 600; }
        
        .user-info { padding: 25px; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; font-size: 0.95rem; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary-dark); border: 2px solid var(--primary); }

        /* Conte√∫do Principal */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        header { background: var(--bg-card); padding: 20px 30px; display: none; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); z-index: 1000; }
        .page-content { flex: 1; overflow-y: auto; padding: 30px; padding-bottom: 80px; }
        h2 { font-weight: 600; color: var(--text-main); font-size: 1.5rem; }

        /* --- 4. COMPONENTES UI (Estilo Cards Premium) --- */
        .card { 
            background: var(--bg-card); 
            padding: 25px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow-md); /* Sombra suave */
            margin-bottom: 25px; 
            color: var(--text-main);
            border: 1px solid var(--border-color); /* Borda sutil */
        }
        
        /* Cards de Resumo (Topo) */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 35px; }
        .summary-card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        /* Barrinha colorida lateral no card */
        .summary-card::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 6px; }
        .summary-card.saldo::before { background: var(--primary); }
        .summary-card.receitas::before { background: var(--accent-green); }
        .summary-card.despesas::before { background: var(--accent-red); }

        .summary-label { font-size: 0.95rem; font-weight: 500; color: var(--text-muted); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;}
        .summary-balance { font-size: 2.2rem; font-weight: 700; color: var(--text-main); }
        
        /* Grids de Layout */
        .dashboard-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 25px; }
        
        /* Tabelas Modernas */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 600px; }
        th { text-align: left; color: var(--text-muted); font-weight: 600; padding: 15px 20px; border-bottom: 2px solid var(--border-color); font-size: 0.9rem; }
        td { padding: 20px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        tbody tr:hover { background-color: rgba(0,0,0,0.02); }
        
        /* Bot√µes e Forms */
        .btn { padding: 14px 24px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-family: 'Poppins', sans-serif;}
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(26, 115, 232, 0.3); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-icon { background: rgba(0,0,0,0.05); border: none; cursor: pointer; font-size: 1.1rem; padding: 8px; border-radius: 8px; margin-left: 5px; color: var(--text-muted); transition: 0.2s;}
        .btn-icon:hover { background: rgba(0,0,0,0.1); color: var(--text-main); }
        
        .form-control, select.form-control { 
            width: 100%; padding: 14px; border: 2px solid var(--border-color); 
            background: var(--bg-body); color: var(--text-main); border-radius: 12px; 
            margin-bottom: 20px; font-size: 1rem; transition: 0.3s; outline: none;
            font-family: 'Poppins', sans-serif;
        }
        .form-control:focus { border-color: var(--primary); background: var(--bg-card); }
        .label { font-weight: 600; margin-bottom: 8px; display: block; color: var(--text-main); font-size: 0.95rem; }

        /* --- 5. MODAIS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 4000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
            backdrop-filter: blur(4px);
        }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-box {
            background: var(--bg-card); padding: 35px; border-radius: 20px; width: 90%; max-width: 450px;
            transform: translateY(30px); transition: 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); box-shadow: var(--shadow-md);
        }
        .modal-overlay.open .modal-box { transform: translateY(0); }
        .modal-actions { display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px; }

        /* --- 6. TOASTS --- */
        #toast-container { position: fixed; top: 30px; right: 30px; z-index: 5000; display: flex; flex-direction: column; gap: 15px; }
        .toast { padding: 18px 25px; background: var(--bg-card); border-left: 6px solid var(--accent-green); box-shadow: var(--shadow-md); border-radius: 12px; animation: slideIn 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); display: flex; align-items: center; gap: 12px; font-weight: 500; }
        @keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- 7. MOBILE --- */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1500; opacity: 0; visibility: hidden; transition: 0.3s; }
        #overlay.visible { opacity: 1; visibility: visible; }
        .screen { display: none; animation: fadeIn 0.3s ease-out; } .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { 
            #sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); }
            #sidebar.open { transform: translateX(0); }
            header { display: flex; }
            .btn-close-menu { display: block !important; color: var(--accent-red); text-align: center; margin-top: 20px; cursor: pointer; font-weight: 600; padding: 15px; }
            .summary-card { padding: 25px; }
            .summary-balance { font-size: 1.8rem; }
        }
        .btn-close-menu { display: none; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="login-screen">
        <div class="login-card">
            <h1 style="color:var(--primary); margin-bottom: 15px; font-weight: 700;">FinControl Premium</h1>
            <p style="color: var(--text-muted);">Seu controle financeiro, elevado.</p>
            <div id="login-loader" class="loader" style="display:none;"></div>
            <div id="login-buttons">
                <button class="btn-google" onclick="fazerLogin()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24">
                    Entrar com Google
                </button>
            </div>
        </div>
    </div>

    <div id="modal-delete" class="modal-overlay">
        <div class="modal-box">
            <h3 style="font-size: 1.4rem; margin-bottom: 15px;">üóëÔ∏è Excluir Item?</h3>
            <p style="color:var(--text-muted); line-height: 1.6;">Essa a√ß√£o √© irrevers√≠vel e apagar√° o dado permanentemente da sua conta na nuvem.</p>
            <div class="modal-actions">
                <button class="btn" style="background:var(--bg-body); color:var(--text-muted);" onclick="fecharModal('modal-delete')">Cancelar</button>
                <button class="btn btn-danger" id="btn-confirm-delete">Sim, Excluir Permanentemente</button>
            </div>
        </div>
    </div>

    <div class="app-layout" id="app-interface">
        <div id="overlay" onclick="toggleMenu(false)"></div>

        <aside id="sidebar">
            <div class="brand">
                <span style="background: var(--primary); color: white; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">FC</span>
                FinControl
            </div>
            <ul class="menu-list">
                <li><a class="menu-link active" onclick="navegar('dashboard', this)"><span class="icon">üìä</span> Vis√£o Geral</a></li>
                <li><a class="menu-link" onclick="navegar('lancamentos', this)"><span class="icon">üìù</span> Extrato</a></li>
                <li><a class="menu-link" onclick="navegar('adicionar', this)"><span class="icon">‚ûï</span> Novo Lan√ßamento</a></li>
                <li><a class="menu-link" onclick="navegar('config', this)"><span class="icon">‚öôÔ∏è</span> Configura√ß√µes</a></li>
                <li><a class="menu-link" onclick="alternarTema()"><span class="icon">üåì</span> Alternar Tema</a></li>
                <li class="btn-close-menu" onclick="toggleMenu(false)">‚úï Fechar Menu</li>
            </ul>
            <div class="user-info">
                <img id="user-photo" class="user-avatar" src="" alt="">
                <div style="overflow: hidden;">
                    <div id="user-name" style="font-weight:600; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">Usu√°rio</div>
                    <div onclick="auth.signOut()" style="color:var(--accent-red); cursor:pointer; font-size:0.85rem; font-weight: 500;">Sair da conta</div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header>
                <strong style="color:var(--primary); font-size: 1.2rem;">Vis√£o Geral</strong>
                <button onclick="toggleMenu(true)" style="background:none; border:none; font-size:28px; color: var(--text-main); cursor: pointer;">‚ò∞</button>
            </header>

            <div class="page-content">
                
                <section id="dashboard" class="screen active">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                        <div>
                            <h2 style="margin-bottom: 5px;">Bom dia!</h2>
                            <p style="color: var(--text-muted);">Aqui est√° o resumo das suas finan√ßas.</p>
                        </div>
                        <select id="filtro-mes" onchange="renderizarInterface()" class="form-control" style="width:auto; margin:0; padding: 10px 15px; font-size: 0.9rem;">
                            <option value="atual">üìÖ Este M√™s</option>
                            <option value="todos">üìÖ Todo o Per√≠odo</option>
                        </select>
                    </div>

                    <div class="summary-grid">
                        <div class="summary-card saldo">
                            <div class="summary-label"><span style="color: var(--primary);">‚óè</span> Saldo Atual</div>
                            <div class="summary-balance" id="dash-saldo">R$ 0,00</div>
                        </div>
                        <div class="summary-card receitas">
                            <div class="summary-label"><span style="color: var(--accent-green);">‚Üë</span> Receitas</div>
                            <div class="summary-balance" style="color:var(--accent-green)" id="dash-ent">R$ 0,00</div>
                        </div>
                        <div class="summary-card despesas">
                            <div class="summary-label"><span style="color: var(--accent-red);">‚Üì</span> Despesas</div>
                            <div class="summary-balance" style="color:var(--accent-red)" id="dash-sai">R$ 0,00</div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="card" style="min-height:380px;">
                            <h3 style="margin-bottom: 25px; font-weight: 600;">Gastos por Categoria</h3>
                            <div style="height: 280px; position: relative;">
                                <canvas id="grafico-rosca"></canvas>
                            </div>
                        </div>
                        <div class="card" style="min-height:380px;">
                            <h3 style="margin-bottom: 25px; font-weight: 600;">Or√ßamento vs. Realizado</h3>
                            <div id="lista-metas-dash" style="display: flex; flex-direction: column; gap: 20px;"></div>
                        </div>
                    </div>
                </section>

                <section id="lancamentos" class="screen">
                    <h2 style="margin-bottom: 25px;">Extrato Detalhado</h2>
                    <div class="card table-container" style="padding: 0;">
                        <table id="tabela-extrato">
                            <thead>
                                <tr style="background: var(--bg-body);">
                                    <th style="padding-left: 30px;">Data / Categoria</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Valor</th>
                                    <th style="text-align: right; padding-right: 30px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section id="adicionar" class="screen">
                    <h2 id="titulo-form" style="margin-bottom: 25px; text-align: center;">Novo Lan√ßamento</h2>
                    <div class="card" style="max-width:550px; margin:0 auto; padding: 40px;">
                        <form id="form-transacao">
                            <input type="hidden" id="input-id">

                            <label class="label">Tipo de Opera√ß√£o</label>
                            <select id="input-tipo" class="form-control"><option value="saida">üí∏ Despesa (Sa√≠da)</option><option value="entrada">üí∞ Receita (Entrada)</option></select>
                            
                            <label class="label">Descri√ß√£o</label>
                            <input type="text" id="input-desc" class="form-control" placeholder="Ex: Compra no Mercado" required>
                            
                            <label class="label">Categoria</label>
                            <select id="input-categoria" class="form-control"></select>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <label class="label">Valor (R$)</label>
                                    <input type="number" step="0.01" id="input-valor" class="form-control" placeholder="0.00" required style="font-weight: bold; font-size: 1.1rem;">
                                </div>
                                <div>
                                    <label class="label">Data</label>
                                    <input type="date" id="input-data" class="form-control" required>
                                </div>
                            </div>

                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <button type="submit" class="btn btn-primary" id="btn-salvar" style="flex: 1; padding: 16px; font-size: 1rem;">Confirmar Lan√ßamento</button>
                                <button type="button" class="btn" id="btn-cancelar" style="background: var(--bg-body); color: var(--text-muted); display: none;" onclick="resetForm()">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </section>

                <section id="config" class="screen">
                    <h2 style="margin-bottom: 25px;">Configura√ß√µes</h2>
                    <div class="card">
                        <h3 style="margin-bottom: 20px;">Gerenciar Categorias e Metas</h3>
                        <p style="color: var(--text-muted); margin-bottom: 25px;">Defina os limites de gastos mensais para cada categoria.</p>
                        
                        <div style="display:flex; gap:15px; background: var(--bg-body); padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid var(--border-color);">
                            <input type="text" id="nova-cat-nome" class="form-control" placeholder="Nome da Categoria" style="margin:0; flex: 2;">
                            <input type="number" id="nova-cat-meta" class="form-control" placeholder="Meta R$" style="margin:0; flex: 1;">
                            <button onclick="addCategoriaCloud()" class="btn btn-primary" style="width:auto; padding: 0 25px; font-size: 1.2rem;">+</button>
                        </div>
                        
                        <div id="lista-cats-config"></div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <script>
        // --- 1. CONFIGURA√á√ÉO FIREBASE (SUAS CHAVES AQUI) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAXU77W9IhtnAlM_vMUEMgM9_WScjEQaVU",
            authDomain: "app-financeiro-c2984.firebaseapp.com",
            projectId: "app-financeiro-c2984",
            storageBucket: "app-financeiro-c2984.firebasestorage.app",
            messagingSenderId: "296730284016",
            appId: "1:296730284016:web:b327a149cf0a7c059ed735",
            measurementId: "G-4XWB5TYSY6"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. ESTADO GLOBAL ---
        let user = null;
        let transacoes = [];
        let categorias = [];
        let chartInstance = null;
        let deleteTarget = { col: null, id: null }; 

        // --- 3. AUTH & LISTENERS ---
        auth.onAuthStateChanged((u) => {
            if (u) {
                user = u;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-interface').style.display = 'flex';
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('user-photo').src = user.photoURL;
                initListeners();
                notificar(`Bem-vindo de volta, ${user.displayName.split(' ')[0]}!`);
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-interface').style.display = 'none';
            }
        });

        function fazerLogin() {
            document.getElementById('login-loader').style.display = 'block';
            document.getElementById('login-buttons').style.display = 'none';
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(erro => {
                alert("Erro: " + erro.message);
                document.getElementById('login-loader').style.display = 'none';
                document.getElementById('login-buttons').style.display = 'block';
            });
        }

        function initListeners() {
            db.collection('users').doc(user.uid).collection('transacoes')
                .orderBy('data', 'desc')
                .onSnapshot(snap => {
                    transacoes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderizarInterface();
                });

            db.collection('users').doc(user.uid).collection('categorias')
                .orderBy('nome', 'asc')
                .onSnapshot(snap => {
                    categorias = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(categorias.length === 0) criarCatsPadrao();
                    renderizarCats();
                });
        }

        function criarCatsPadrao() {
            ['Alimenta√ß√£o', 'Lazer', 'Moradia', 'Sa√∫de', 'Transporte'].forEach(nome => {
                db.collection('users').doc(user.uid).collection('categorias').add({ nome, meta: 1000 });
            });
        }

        // --- 4. RENDERIZA√á√ÉO E INTERFACE ---
        function renderizarInterface() {
            const filtro = document.getElementById('filtro-mes').value;
            const hoje = new Date();
            
            let dados = transacoes;
            if (filtro === 'atual') {
                dados = transacoes.filter(t => {
                    const d = new Date(t.data);
                    const localDate = new Date(d.valueOf() + d.getTimezoneOffset() * 60000);
                    return localDate.getMonth() === hoje.getMonth() && localDate.getFullYear() === hoje.getFullYear();
                });
            }

            let ent=0, sai=0, gastosPorCat={};
            const tbody = document.querySelector('#tabela-extrato tbody');
            tbody.innerHTML = '';

            dados.forEach(t => {
                if(t.tipo === 'entrada') ent += t.val;
                else {
                    sai += t.val;
                    gastosPorCat[t.cat] = (gastosPorCat[t.cat] || 0) + t.val;
                }

                tbody.innerHTML += `
                    <tr>
                        <td style="padding-left: 30px;">
                            <div style="font-weight:600;">${new Date(t.data).toLocaleDateString()}</div>
                            <div style="color:var(--text-muted); font-size:0.9rem;">${t.cat}</div>
                        </td>
                        <td style="font-weight: 500;">${t.desc}</td>
                        <td style="font-weight: 700; color:${t.tipo==='entrada'?'var(--accent-green)':'var(--accent-red)'}">R$ ${t.val.toFixed(2)}</td>
                        <td style="text-align: right; padding-right: 30px;">
                            <button onclick="editarItem('${t.id}')" class="btn-icon">‚úèÔ∏è</button>
                            <button onclick="confirmarDelete('transacoes', '${t.id}')" class="btn-icon" style="color: var(--accent-red);">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });

            document.getElementById('dash-saldo').innerText = `R$ ${(ent-sai).toFixed(2)}`;
            document.getElementById('dash-ent').innerText = `R$ ${ent.toFixed(2)}`;
            document.getElementById('dash-sai').innerText = `R$ ${sai.toFixed(2)}`;

            renderizarGraficos(gastosPorCat);
            renderizarMetas(gastosPorCat);
        }

        function renderizarMetas(gastosAtuais) {
            const div = document.getElementById('lista-metas-dash');
            div.innerHTML = '';
            categorias.forEach(c => {
                const gasto = gastosAtuais[c.nome] || 0;
                const pct = Math.min((gasto/c.meta)*100, 100);
                let corBarra = 'var(--primary)';
                if(pct > 75) corBarra = '#f1c40f'; // Amarelo alerta
                if(pct > 95) corBarra = 'var(--accent-red)'; // Vermelho perigo

                div.innerHTML += `
                    <div>
                        <div style="display:flex; justify-content:space-between; margin-bottom: 8px; font-weight: 500; font-size: 0.95rem;">
                            <span>${c.nome}</span>
                            <span style="color: var(--text-muted);">R$ ${gasto.toFixed(0)} / ${c.meta}</span>
                        </div>
                        <div style="background:var(--bg-body); height:10px; border-radius:5px; overflow:hidden; border: 1px solid var(--border-color);">
                            <div style="width:${pct}%; height:100%; background:${corBarra}; transition: width 0.5s ease-in-out; border-radius: 5px;"></div>
                        </div>
                    </div>`;
            });
        }

        function renderizarCats() {
            const lista = document.getElementById('lista-cats-config');
            const select = document.getElementById('input-categoria');
            lista.innerHTML = ''; select.innerHTML = '';

            categorias.forEach(c => {
                lista.innerHTML += `
                    <div style="padding:15px 20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items: center; background: var(--bg-card);">
                        <div>
                            <div style="font-weight: 600; font-size: 1.05rem;">${c.nome}</div>
                            <div style="color: var(--text-muted); font-size: 0.9rem;">Meta mensal: R$ ${c.meta}</div>
                        </div>
                        <button onclick="confirmarDelete('categorias', '${c.id}')" class="btn-icon" style="color:var(--accent-red); background: rgba(220, 53, 69, 0.1);">üóëÔ∏è</button>
                    </div>`;
                select.innerHTML += `<option value="${c.nome}">${c.nome}</option>`;
            });
        }

        function renderizarGraficos(dados) {
            const ctx = document.getElementById('grafico-rosca').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            const labels = Object.keys(dados);
            const values = Object.values(dados);
            // Paleta de cores profissional
            const colors = ['#1a73e8', '#28a745', '#f1c40f', '#e83e8c', '#6610f2', '#fd7e14', '#20c997'];

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { 
                    labels: labels.length?labels:['Sem dados'], 
                    datasets: [{ 
                        data: values.length?values:[1], 
                        backgroundColor: labels.length?colors:['#e9ecef'], 
                        borderWidth: 2,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-card').trim()
                    }] 
                },
                options: { 
                    maintainAspectRatio: false, 
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, font: { family: "'Poppins', sans-serif" } } }
                    },
                    layout: { padding: { top: 20 } }
                }
            });
        }

        // --- 5. A√á√ïES (SALVAR E EDITAR) ---
        function editarItem(id) {
            const t = transacoes.find(item => item.id === id);
            if(t) {
                document.getElementById('input-id').value = id;
                document.getElementById('input-tipo').value = t.tipo;
                document.getElementById('input-desc').value = t.desc;
                document.getElementById('input-categoria').value = t.cat;
                document.getElementById('input-valor').value = t.val;
                document.getElementById('input-data').value = t.data;

                document.getElementById('btn-salvar').innerText = "Atualizar Lan√ßamento";
                document.getElementById('btn-cancelar').style.display = 'block';
                document.getElementById('titulo-form').innerText = "Editar Lan√ßamento";

                navegar('adicionar');
            }
        }

        function resetForm() {
            document.getElementById('form-transacao').reset();
            document.getElementById('input-id').value = '';
            document.getElementById('input-data').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('btn-salvar').innerText = "Confirmar Lan√ßamento";
            document.getElementById('btn-salvar').disabled = false;
            document.getElementById('btn-cancelar').style.display = 'none';
            document.getElementById('titulo-form').innerText = "Novo Lan√ßamento";
        }

        document.getElementById('form-transacao').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-salvar');
            const idExistente = document.getElementById('input-id').value;

            btn.disabled = true; 
            btn.innerText = "Processando...";

            const dados = {
                tipo: document.getElementById('input-tipo').value,
                desc: document.getElementById('input-desc').value,
                cat: document.getElementById('input-categoria').value,
                val: parseFloat(document.getElementById('input-valor').value),
                data: document.getElementById('input-data').value
            };

            let promessa;
            if (idExistente) {
                promessa = db.collection('users').doc(user.uid).collection('transacoes').doc(idExistente).update(dados);
            } else {
                dados.timestamp = firebase.firestore.FieldValue.serverTimestamp();
                promessa = db.collection('users').doc(user.uid).collection('transacoes').add(dados);
            }

            promessa.then(() => {
                resetForm();
                notificar(idExistente ? "Lan√ßamento atualizado!" : "Lan√ßamento salvo com sucesso!");
                navegar('dashboard');
            }).catch(err => {
                alert("Erro: " + err);
                btn.disabled = false;
                btn.innerText = idExistente ? "Atualizar Lan√ßamento" : "Confirmar Lan√ßamento";
            });
        });

        function addCategoriaCloud() {
            const nome = document.getElementById('nova-cat-nome').value;
            const meta = parseFloat(document.getElementById('nova-cat-meta').value);
            if(nome && meta) {
                db.collection('users').doc(user.uid).collection('categorias').add({ nome, meta });
                document.getElementById('nova-cat-nome').value = '';
                document.getElementById('nova-cat-meta').value = '';
                notificar("Nova categoria adicionada!");
            }
        }

        // --- 6. DELETE SYSTEM ---
        function confirmarDelete(col, id) {
            deleteTarget = { col, id };
            document.getElementById('modal-delete').classList.add('open');
        }

        document.getElementById('btn-confirm-delete').onclick = () => {
            if(deleteTarget.id) {
                db.collection('users').doc(user.uid).collection(deleteTarget.col).doc(deleteTarget.id).delete();
                notificar("Item exclu√≠do permanentemente.");
                fecharModal('modal-delete');
            }
        };

        // --- UTILS ---
        function navegar(tela, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(tela).classList.add('active');
            if(el) { document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active')); el.classList.add('active'); }
            toggleMenu(false);
        }

        function toggleMenu(s) {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            if(s){ sb.classList.add('open'); ov.classList.add('visible'); }
            else { sb.classList.remove('open'); ov.classList.remove('visible'); }
        }

        function alternarTema() {
            const b = document.body;
            if(b.hasAttribute('data-theme')) { 
                b.removeAttribute('data-theme'); localStorage.setItem('theme', 'light'); 
                chartInstance.options.datasets[0].borderColor = '#ffffff';
            } else { 
                b.setAttribute('data-theme', 'dark'); localStorage.setItem('theme', 'dark');
                chartInstance.options.datasets[0].borderColor = '#1e1e1e';
            }
            chartInstance.update();
        }

        function notificar(msg) {
            const t = document.createElement('div'); t.className = 'toast';
            t.innerHTML = `<span style="font-size: 1.2rem;">‚ú®</span> ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(()=>t.remove(), 3500);
        }
        function fecharModal(id) { document.getElementById(id).classList.remove('open'); }

        // Init
        document.getElementById('input-data').value = new Date().toISOString().split('T')[0];
        if(localStorage.getItem('theme')==='dark') document.body.setAttribute('data-theme', 'dark');
    </script>
</body>
</html>
