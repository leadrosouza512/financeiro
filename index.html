<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinControl Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --primary: #820ad1; --secondary: #00d283; --danger: #ff4757; 
            --bg-body: #f3f4f6; --bg-card: #ffffff; --text-main: #1e272e;
            --border: #e1e1e6; --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        [data-theme="dark"] {
            --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #f3f4f6;
            --border: #333; --shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; transition: 0.3s; }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-box {
            background: var(--bg-card); padding: 40px; border-radius: 20px;
            box-shadow: var(--shadow); text-align: center; max-width: 400px; width: 90%;
        }
        .btn-google {
            background: #fff; color: #444; border: 1px solid #ddd;
            padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-top: 20px;
        }
        .btn-google:hover { background: #f1f1f1; }

        /* --- APP LAYOUT --- */
        .app-layout { display: flex; height: 100%; display: none; /* Escondido at√© logar */ }
        .sidebar { width: 260px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 2000; transition: 0.3s; }
        .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-header { background: var(--bg-card); padding: 15px 20px; display: none; justify-content: space-between; align-items: center; box-shadow: var(--shadow); z-index: 1000; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }

        /* --- COMPONENTS --- */
        .card { background: var(--bg-card); border-radius: 16px; padding: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card.primary { background: linear-gradient(135deg, var(--primary), #6e08b1); color: white; }
        .stat-value { font-size: 2rem; font-weight: 700; }
        
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 15px; border-bottom: 1px solid var(--border); text-align: left; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .form-input { width: 100%; padding: 12px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); border-radius: 8px; margin-bottom: 15px; }
        
        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive */
        .overlay-mobile { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1500; opacity: 0; visibility: hidden; transition: 0.3s; }
        .overlay-mobile.visible { opacity: 1; visibility: visible; }
        .screen { display: none; animation: fadeIn 0.3s; } .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; left: -280px; }
            .sidebar.active { transform: translateX(280px); }
            .top-header { display: flex; }
        }
        
        /* User Info in Sidebar */
        .user-info { padding: 20px; border-top: 1px solid var(--border); margin-top: auto; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; background: var(--primary); color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color: var(--primary);">FinControl Cloud</h1>
            <p style="color: var(--text-main); opacity: 0.7; margin: 10px 0;">Seus dados, em qualquer lugar.</p>
            <div id="login-loader" class="loader" style="display: none;"></div>
            <button class="btn-google" onclick="fazerLogin()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                Entrar com Google
            </button>
        </div>
    </div>

    <div class="app-layout" id="app-interface">
        <div id="overlay-mobile" class="overlay-mobile" onclick="toggleMenu(false)"></div>

        <aside class="sidebar" id="sidebar">
            <div style="padding: 25px; font-size: 1.5rem; font-weight: 800; color: var(--primary);">üöÄ FinCloud</div>
            <ul style="list-style: none; padding: 0 15px; margin-top: 20px;">
                <li style="margin-bottom: 5px;"><div onclick="navegar('dashboard')" style="padding: 12px; cursor: pointer;">üìä Dashboard</div></li>
                <li style="margin-bottom: 5px;"><div onclick="navegar('lancamentos')" style="padding: 12px; cursor: pointer;">üìù Extrato</div></li>
                <li style="margin-bottom: 5px;"><div onclick="navegar('adicionar')" style="padding: 12px; cursor: pointer;">‚ûï Novo</div></li>
                <li style="margin-bottom: 5px;"><div onclick="navegar('config')" style="padding: 12px; cursor: pointer;">‚öôÔ∏è Config</div></li>
            </ul>
            <div class="user-info">
                <img id="user-photo" class="user-avatar" src="" alt="U">
                <div>
                    <div id="user-name" style="font-weight: bold;">Usu√°rio</div>
                    <div onclick="fazerLogout()" style="color: var(--danger); cursor: pointer; font-size: 0.8rem;">Sair da conta</div>
                </div>
            </div>
        </aside>

        <main class="main-wrapper">
            <header class="top-header">
                <strong style="color:var(--primary)">FinControl</strong>
                <button onclick="toggleMenu(true)" style="background:none; border:none; font-size: 24px;">‚ò∞</button>
            </header>

            <div class="content-scroll">
                
                <section id="dashboard" class="screen active">
                    <h2>Vis√£o Geral</h2><br>
                    <div class="stats-grid">
                        <div class="card stat-card primary">
                            <small style="opacity:0.8">Saldo Atual</small>
                            <div class="stat-value" id="dash-saldo">R$ 0,00</div>
                        </div>
                        <div class="card"><small>Receitas</small><div class="stat-value" style="color:var(--secondary)" id="dash-receitas">R$ 0,00</div></div>
                        <div class="card"><small>Despesas</small><div class="stat-value" style="color:var(--danger)" id="dash-despesas">R$ 0,00</div></div>
                    </div>
                    <div class="card" style="height: 300px;"><canvas id="grafico-rosca"></canvas></div>
                </section>

                <section id="lancamentos" class="screen">
                    <h2>Extrato</h2><br>
                    <div class="card" style="overflow-x:auto;">
                        <table id="tabela-extrato"><thead><tr><th>Data</th><th>Desc</th><th>Valor</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table>
                    </div>
                </section>

                <section id="adicionar" class="screen">
                    <h2>Novo Lan√ßamento</h2><br>
                    <div class="card" style="max-width: 600px; margin: 0 auto;">
                        <form id="form-transacao">
                            <select id="input-tipo" class="form-input"><option value="saida">üí∏ Despesa</option><option value="entrada">üí∞ Receita</option></select>
                            <input type="text" id="input-desc" class="form-input" placeholder="Descri√ß√£o" required>
                            <select id="input-categoria" class="form-input"></select>
                            <input type="number" step="0.01" id="input-valor" class="form-input" placeholder="0.00" required>
                            <input type="date" id="input-data" class="form-input" required>
                            <button type="submit" class="btn btn-primary" id="btn-salvar">Salvar na Nuvem</button>
                        </form>
                    </div>
                </section>

                <section id="config" class="screen">
                    <h2>Configura√ß√µes</h2><br>
                    <div class="card">
                        <h3>Categorias</h3><br>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="nova-cat-nome" class="form-input" placeholder="Nome" style="margin:0;">
                            <input type="number" id="nova-cat-meta" class="form-input" placeholder="Meta" style="margin:0;">
                            <button onclick="addCategoriaCloud()" class="btn" style="background:var(--secondary); color:white;">+</button>
                        </div>
                        <div id="lista-cats" style="margin-top:20px;"></div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <script>
        // --- 1. CONFIGURA√á√ÉO DO FIREBASE (COLE SUA CHAVE AQUI) ---
        // Voc√™ pegou isso no Passo 3 do painel do Firebase. Substitua tudo dentro das chaves {}.
        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAXU77W9IhtnAlM_vMUEMgM9_WScjEQaVU",
  authDomain: "app-financeiro-c2984.firebaseapp.com",
  projectId: "app-financeiro-c2984",
  storageBucket: "app-financeiro-c2984.firebasestorage.app",
  messagingSenderId: "296730284016",
  appId: "1:296730284016:web:b327a149cf0a7c059ed735",
  measurementId: "G-4XWB5TYSY6"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

        // Inicializa Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. ESTADO GLOBAL ---
        let user = null;
        let transacoes = [];
        let categorias = [];
        let chartInstance = null;

        // --- 3. AUTENTICA√á√ÉO ---
        auth.onAuthStateChanged((u) => {
            if (u) {
                user = u;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-interface').style.display = 'flex';
                
                // Atualiza UI do usu√°rio
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('user-photo').src = user.photoURL;

                // Inicia sincroniza√ß√£o em Tempo Real
                iniciarSincronizacao();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-interface').style.display = 'none';
            }
        });

        function fazerLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(erro => alert("Erro ao logar: " + erro.message));
        }

        function fazerLogout() {
            auth.signOut();
            location.reload();
        }

        // --- 4. BANCO DE DADOS (FIRESTORE) ---
        
        // "Ouvir" o banco de dados (Realtime)
        function iniciarSincronizacao() {
            const userRef = db.collection('users').doc(user.uid);

            // Ouvir Transa√ß√µes
            userRef.collection('transacoes').onSnapshot((snapshot) => {
                transacoes = [];
                snapshot.forEach(doc => {
                    transacoes.push({ id: doc.id, ...doc.data() });
                });
                atualizarInterface();
            });

            // Ouvir Categorias
            userRef.collection('categorias').onSnapshot((snapshot) => {
                categorias = [];
                snapshot.forEach(doc => {
                    categorias.push({ id: doc.id, ...doc.data() });
                });
                // Se n√£o tiver categorias (primeiro acesso), cria padr√µes
                if(categorias.length === 0) criarCategoriasPadrao();
                renderizarConfigCats();
                atualizarSelectCategorias();
            });
        }

        function criarCategoriasPadrao() {
            const padroes = [
                { nome: 'Moradia', meta: 2000 },
                { nome: 'Alimenta√ß√£o', meta: 1000 },
                { nome: 'Lazer', meta: 500 }
            ];
            padroes.forEach(c => db.collection('users').doc(user.uid).collection('categorias').add(c));
        }

        // Adicionar Transa√ß√£o
        document.getElementById('form-transacao').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-salvar');
            btn.innerText = "Salvando...";
            btn.disabled = true;

            const nova = {
                tipo: document.getElementById('input-tipo').value,
                desc: document.getElementById('input-desc').value,
                cat: document.getElementById('input-categoria').value,
                val: parseFloat(document.getElementById('input-valor').value),
                data: document.getElementById('input-data').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // Ordena√ß√£o
            };

            db.collection('users').doc(user.uid).collection('transacoes').add(nova)
                .then(() => {
                    e.target.reset();
                    document.getElementById('input-data').value = new Date().toISOString().split('T')[0];
                    navegar('dashboard');
                })
                .catch(err => alert("Erro: " + err))
                .finally(() => {
                    btn.innerText = "Salvar na Nuvem";
                    btn.disabled = false;
                });
        });

        // Deletar
        function deletarItem(collection, id) {
            if(confirm("Excluir item?")) {
                db.collection('users').doc(user.uid).collection(collection).doc(id).delete();
            }
        }

        // Adicionar Categoria
        function addCategoriaCloud() {
            const nome = document.getElementById('nova-cat-nome').value;
            const meta = parseFloat(document.getElementById('nova-cat-meta').value);
            if(nome && meta) {
                db.collection('users').doc(user.uid).collection('categorias').add({ nome, meta });
                document.getElementById('nova-cat-nome').value = '';
                document.getElementById('nova-cat-meta').value = '';
            }
        }

        // --- 5. RENDERIZA√á√ÉO ---
        function atualizarInterface() {
            let ent=0, sai=0, catGastos={};
            const tb = document.querySelector('#tabela-extrato tbody');
            tb.innerHTML = '';

            // Ordenar por data
            transacoes.sort((a,b) => new Date(b.data) - new Date(a.data));

            transacoes.forEach(t => {
                if(t.tipo === 'entrada') ent += t.val;
                else { 
                    sai += t.val;
                    catGastos[t.cat] = (catGastos[t.cat] || 0) + t.val;
                }

                tb.innerHTML += `
                    <tr>
                        <td>${new Date(t.data).toLocaleDateString()}</td>
                        <td>${t.desc}<br><small>${t.cat}</small></td>
                        <td style="color:${t.tipo==='entrada'?'var(--secondary)':'var(--danger)'}">R$ ${t.val.toFixed(2)}</td>
                        <td><button onclick="deletarItem('transacoes', '${t.id}')" style="border:none;background:none;cursor:pointer;">üóëÔ∏è</button></td>
                    </tr>`;
            });

            document.getElementById('dash-saldo').innerText = `R$ ${(ent-sai).toFixed(2)}`;
            document.getElementById('dash-receitas').innerText = `R$ ${ent.toFixed(2)}`;
            document.getElementById('dash-despesas').innerText = `R$ ${sai.toFixed(2)}`;
            renderizarGrafico(catGastos);
        }

        function renderizarConfigCats() {
            const div = document.getElementById('lista-cats');
            div.innerHTML = '';
            categorias.forEach(c => {
                div.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <span><b>${c.nome}</b> (Meta: ${c.meta})</span>
                    <button onclick="deletarItem('categorias', '${c.id}')" style="border:none;background:none;cursor:pointer;color:red;">‚úï</button>
                </div>`;
            });
        }

        function atualizarSelectCategorias() {
            const sel = document.getElementById('input-categoria');
            sel.innerHTML = '';
            categorias.forEach(c => {
                sel.innerHTML += `<option value="${c.nome}">${c.nome}</option>`;
            });
        }

        function renderizarGrafico(dados) {
            const ctx = document.getElementById('grafico-rosca').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dados),
                    datasets: [{ data: Object.values(dados), backgroundColor: ['#820ad1','#00d283','#ff4757','#ffa502'] }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        // --- UTILS ---
        function navegar(tela) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(tela).classList.add('active');
            toggleMenu(false);
        }
        function toggleMenu(s) {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay-mobile');
            if(s){ sb.classList.add('active'); ov.classList.add('visible'); }
            else { sb.classList.remove('active'); ov.classList.remove('visible'); }
        }
        
        // Init Date
        document.getElementById('input-data').value = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>

