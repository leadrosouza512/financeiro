<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinControl Enterprise</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- 1. DESIGN SYSTEM & RESET --- */
        :root {
            --primary: #820ad1; 
            --primary-hover: #6e08b1;
            --secondary: #00d283; 
            --danger: #ff4757; 
            --bg-body: #f3f4f6; 
            --bg-card: #ffffff;
            --text-main: #1e272e;
            --text-muted: #808e9b;
            --border: #e1e1e6;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        [data-theme="dark"] {
            --bg-body: #121212; 
            --bg-card: #1e1e1e; 
            --text-main: #f3f4f6;
            --text-muted: #a4b0be;
            --border: #333;
            --shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; transition: background 0.3s, color 0.3s; }

        /* --- 2. LAYOUT GRID --- */
        .app-layout { display: flex; height: 100%; position: relative; }

        /* SIDEBAR (Navega√ß√£o) */
        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 2000; /* Prioridade Alta */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .brand-container { padding: 25px; display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        
        .nav-list { list-style: none; padding: 0 15px; margin-top: 20px; flex: 1; }
        .nav-item { margin-bottom: 5px; }
        .nav-link {
            display: flex; align-items: center; padding: 12px 15px; 
            color: var(--text-muted); text-decoration: none; border-radius: 8px; 
            font-weight: 500; transition: all 0.2s; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active { background-color: rgba(130, 10, 209, 0.08); color: var(--primary); }
        .nav-icon { width: 24px; text-align: center; margin-right: 12px; font-size: 1.2rem; }

        /* MAIN CONTENT */
        .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* HEADER MOBILE */
        .top-header {
            background: var(--bg-card);
            padding: 15px 20px;
            display: none; /* Desktop default */
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; scroll-behavior: smooth; }

        /* --- 3. UI COMPONENTS --- */
        /* Cards */
        .card { background: var(--bg-card); border-radius: 16px; padding: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 1.1rem; font-weight: 600; }
        
        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { position: relative; overflow: hidden; }
        .stat-card.primary { background: linear-gradient(135deg, var(--primary), var(--primary-hover)); color: white; }
        .stat-card.primary .stat-label { color: rgba(255,255,255,0.8); }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px; }
        .stat-value { font-size: 2rem; font-weight: 700; }
        .text-success { color: var(--secondary); }
        .text-danger { color: var(--danger); }

        /* Gr√°ficos e Tabelas */
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; color: var(--text-muted); font-size: 0.85rem; padding: 15px 10px; border-bottom: 1px solid var(--border); }
        td { padding: 15px 10px; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        
        /* Buttons & Forms */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; width: 100%; padding: 14px; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; }
        
        .form-group { margin-bottom: 15px; }
        .form-input { 
            width: 100%; padding: 12px; border: 1px solid var(--border); 
            background: var(--bg-body); color: var(--text-main); 
            border-radius: 8px; outline: none; font-size: 1rem;
        }
        .form-input:focus { border-color: var(--primary); }

        /* --- 4. MODAL SYSTEM (Custom Dialogs) --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 5000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: 0.2s ease-in-out;
            backdrop-filter: blur(2px);
        }
        .modal-backdrop.open { opacity: 1; visibility: visible; }
        
        .modal-container {
            background: var(--bg-card); width: 90%; max-width: 450px;
            padding: 30px; border-radius: 16px;
            transform: translateY(20px) scale(0.95); transition: 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .modal-backdrop.open .modal-container { transform: translateY(0) scale(1); }
        
        .modal-title { font-size: 1.4rem; font-weight: bold; margin-bottom: 10px; }
        .modal-desc { color: var(--text-muted); margin-bottom: 25px; line-height: 1.5; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }

        /* --- 5. RESPONSIVIDADE E UTILIT√ÅRIOS --- */
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .overlay-mobile {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1500;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .overlay-mobile.visible { opacity: 1; visibility: visible; }

        @media (max-width: 900px) { .charts-row { grid-template-columns: 1fr; } }
        
        @media (max-width: 768px) { 
            .sidebar { position: fixed; height: 100%; left: -280px; }
            .sidebar.active { transform: translateX(280px); }
            .top-header { display: flex; }
            .content-scroll { padding: 20px; padding-bottom: 100px; }
            .btn-close-mobile { display: block !important; margin-top: auto; color: var(--danger); text-align: center; padding: 20px; border-top: 1px solid var(--border); cursor: pointer; }
        }
        .btn-close-mobile { display: none; }
    </style>
</head>
<body>

    <div id="modal-delete" class="modal-backdrop">
        <div class="modal-container">
            <div class="modal-title">üóëÔ∏è Excluir Item</div>
            <p class="modal-desc">Voc√™ tem certeza absoluta? Esta a√ß√£o remover√° o registro permanentemente do banco de dados local.</p>
            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="fecharModal('modal-delete')">Cancelar</button>
                <button class="btn btn-danger" id="btn-confirmar-delete">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <div id="modal-categoria" class="modal-backdrop">
        <div class="modal-container">
            <div class="modal-title">üìÇ Nova Categoria</div>
            <p class="modal-desc">Defina o nome da categoria e um teto de gastos mensal (Budget) para ela.</p>
            
            <div class="form-group">
                <label style="font-size:0.9rem; font-weight:600;">Nome da Categoria</label>
                <input type="text" id="cat-nome" class="form-input" placeholder="Ex: Assinaturas">
            </div>
            <div class="form-group">
                <label style="font-size:0.9rem; font-weight:600;">Limite Mensal (R$)</label>
                <input type="number" id="cat-valor" class="form-input" placeholder="0.00">
            </div>

            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="fecharModal('modal-categoria')">Cancelar</button>
                <button class="btn btn-primary" style="width:auto;" onclick="salvarNovaCategoria()">Criar Categoria</button>
            </div>
        </div>
    </div>

    <div class="app-layout">
        
        <div id="overlay-mobile" class="overlay-mobile" onclick="toggleMenu(false)"></div>

        <aside class="sidebar" id="sidebar">
            <div class="brand-container">üöÄ FinEnterprise</div>
            
            <ul class="nav-list">
                <li class="nav-item"><a class="nav-link active" onclick="navegar('dashboard', this)"><span class="nav-icon">üìä</span> Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navegar('lancamentos', this)"><span class="nav-icon">üìù</span> Extrato</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navegar('adicionar', this)"><span class="nav-icon">‚ûï</span> Novo</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navegar('config', this)"><span class="nav-icon">‚öôÔ∏è</span> Configura√ß√µes</a></li>
                <li class="nav-item"><a class="nav-link" onclick="alternarTema()"><span class="nav-icon">üåì</span> Tema</a></li>
            </ul>

            <div class="btn-close-mobile" onclick="toggleMenu(false)">‚úï Fechar Menu</div>
        </aside>

        <main class="main-wrapper">
            <header class="top-header">
                <div style="font-weight: 700; color: var(--primary);">FinControl</div>
                <button onclick="toggleMenu(true)" class="btn-icon" style="font-size: 1.5rem;">‚ò∞</button>
            </header>

            <div class="content-scroll">
                
                <section id="dashboard" class="screen active">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2>Vis√£o Geral</h2>
                        <select id="filtro-periodo" onchange="atualizarDashboard()" style="padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main);">
                            <option value="atual">Este M√™s</option>
                            <option value="todos">Todo o Per√≠odo</option>
                        </select>
                    </div>

                    <div class="stats-grid">
                        <div class="card stat-card primary">
                            <div class="stat-label">Saldo em Conta</div>
                            <div class="stat-value" id="dash-saldo">R$ 0,00</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-label">Total Receitas</div>
                            <div class="stat-value text-success" id="dash-receitas">R$ 0,00</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-label">Total Despesas</div>
                            <div class="stat-value text-danger" id="dash-despesas">R$ 0,00</div>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="card" style="min-height: 300px;">
                            <div class="card-header"><span class="card-title">Distribui√ß√£o de Gastos</span></div>
                            <div style="height: 200px; position:relative;"><canvas id="grafico-rosca"></canvas></div>
                        </div>
                        <div class="card" style="min-height: 300px;">
                            <div class="card-header"><span class="card-title">Metas e Or√ßamentos</span></div>
                            <div id="lista-metas-dash" style="display:flex; flex-direction:column; gap:15px;"></div>
                        </div>
                    </div>
                </section>

                <section id="lancamentos" class="screen">
                    <div class="card-header">
                        <h2>Extrato Detalhado</h2>
                        <button class="btn btn-sm btn-primary" style="width:auto;" onclick="navegar('adicionar')">+ Novo Lan√ßamento</button>
                    </div>
                    
                    <div class="card table-responsive">
                        <table id="tabela-extrato">
                            <thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√£o</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section id="adicionar" class="screen">
                    <h2>Novo Lan√ßamento</h2>
                    <br>
                    <div class="card" style="max-width: 600px; margin: 0 auto;">
                        <form id="form-transacao">
                            <input type="hidden" id="input-id">
                            
                            <div class="form-group">
                                <label>Tipo de Opera√ß√£o</label>
                                <select id="input-tipo" class="form-input">
                                    <option value="saida">üí∏ Despesa (Sa√≠da)</option>
                                    <option value="entrada">üí∞ Receita (Entrada)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Descri√ß√£o</label>
                                <input type="text" id="input-desc" class="form-input" required placeholder="Ex: Compra no Mercado">
                            </div>

                            <div class="form-group">
                                <label>Categoria</label>
                                <select id="input-categoria" class="form-input"></select> </div>

                            <div class="form-group">
                                <label>Valor (R$)</label>
                                <input type="number" step="0.01" id="input-valor" class="form-input" required placeholder="0.00">
                            </div>

                            <div class="form-group">
                                <label>Data</label>
                                <input type="date" id="input-data" class="form-input" required>
                            </div>

                            <button type="submit" class="btn btn-primary">Salvar Lan√ßamento</button>
                        </form>
                    </div>
                </section>

                <section id="config" class="screen">
                    <h2>Configura√ß√µes do Sistema</h2>
                    <br>
                    
                    <div class="card">
                        <div class="card-header"><span class="card-title">Gerenciar Categorias</span></div>
                        <button class="btn btn-sm" style="border:1px solid var(--border); margin-bottom:15px;" onclick="abrirModalCategoria()">+ Nova Categoria</button>
                        <div id="config-lista-cats"></div>
                    </div>

                    <div class="card">
                        <div class="card-header"><span class="card-title">Backup e Dados</span></div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn btn-sm" style="background:var(--secondary); color:white;" onclick="exportarDados()">üì• Baixar Backup</button>
                            <label class="btn btn-sm" style="border:1px solid var(--border); cursor:pointer;">
                                üì§ Restaurar Backup <input type="file" hidden onchange="importarDados(this)">
                            </label>
                            <button class="btn btn-sm btn-danger" onclick="if(confirm('Zerar tudo?')) { localStorage.clear(); location.reload(); }">‚ö†Ô∏è Resetar F√°brica</button>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <script>
        // ESTADO GLOBAL
        let transacoes = JSON.parse(localStorage.getItem('fin_ent_data')) || [];
        let categorias = JSON.parse(localStorage.getItem('fin_ent_cats')) || { 'Moradia': 2000, 'Alimenta√ß√£o': 1500, 'Transporte': 500, 'Lazer': 400 };
        let chartInstance = null;
        
        // Contexto para o Modal de Delete (O que estamos deletando?)
        let contextoDelecao = { tipo: null, id: null };

        // --- 1. INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            // Data de hoje no form
            document.getElementById('input-data').value = new Date().toISOString().split('T')[0];
            
            // Tema
            if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

            atualizarSelectCategorias();
            atualizarDashboard();
        });

        // --- 2. NAVEGA√á√ÉO & MENU ---
        function navegar(telaId, elLink) {
            // Esconde todas
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            // Mostra alvo
            document.getElementById(telaId).classList.add('active');
            
            // Atualiza Menu Ativo
            if(elLink) {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                elLink.classList.add('active');
            }

            // Se for mobile, fecha o menu
            toggleMenu(false);

            // Se for para o dashboard ou extrato, for√ßa renderiza√ß√£o
            if(telaId === 'dashboard') atualizarDashboard();
            if(telaId === 'lancamentos') renderizarExtrato();
        }

        function toggleMenu(forceState) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay-mobile');
            
            if (forceState === true) {
                sidebar.classList.add('active');
                overlay.classList.add('visible');
            } else {
                sidebar.classList.remove('active');
                overlay.classList.remove('visible');
            }
        }

        function alternarTema() {
            if(document.body.hasAttribute('data-theme')) {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        // --- 3. MODAL SYSTEM (CORE) ---
        function fecharModal(modalId) {
            document.getElementById(modalId).classList.remove('open');
        }

        // Modal Categoria
        function abrirModalCategoria() {
            document.getElementById('cat-nome').value = '';
            document.getElementById('cat-valor').value = '';
            document.getElementById('modal-categoria').classList.add('open');
        }

        function salvarNovaCategoria() {
            const nome = document.getElementById('cat-nome').value.trim();
            const valor = parseFloat(document.getElementById('cat-valor').value);

            if(!nome || isNaN(valor)) return alert("Preencha corretamente!");
            
            // Capitalizar
            const nomeCap = nome.charAt(0).toUpperCase() + nome.slice(1);
            
            categorias[nomeCap] = valor;
            salvarTudo();
            atualizarSelectCategorias();
            renderizarConfigCats();
            fecharModal('modal-categoria');
        }

        // Modal Delete
        function solicitarDelecao(id, tipo) {
            contextoDelecao = { id, tipo };
            document.getElementById('modal-delete').classList.add('open');
        }

        document.getElementById('btn-confirmar-delete').onclick = () => {
            if (contextoDelecao.tipo === 'transacao') {
                transacoes = transacoes.filter(t => t.id !== contextoDelecao.id);
            } else if (contextoDelecao.tipo === 'categoria') {
                delete categorias[contextoDelecao.id];
            }
            
            salvarTudo();
            
            // Atualiza a tela que estiver aberta
            atualizarDashboard(); 
            renderizarExtrato();
            renderizarConfigCats();
            atualizarSelectCategorias();

            fecharModal('modal-delete');
        };

        // --- 4. CRUD TRANSA√á√ïES ---
        document.getElementById('form-transacao').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const novoItem = {
                id: Date.now(), // ID √∫nico baseado em timestamp
                tipo: document.getElementById('input-tipo').value,
                desc: document.getElementById('input-desc').value,
                cat: document.getElementById('input-categoria').value,
                val: parseFloat(document.getElementById('input-valor').value),
                data: document.getElementById('input-data').value
            };

            transacoes.push(novoItem);
            salvarTudo();
            
            // Reset e Redireciona
            e.target.reset();
            document.getElementById('input-data').value = new Date().toISOString().split('T')[0];
            navegar('dashboard');
        });

        // --- 5. RENDERIZA√á√ÉO E DADOS ---
        function salvarTudo() {
            localStorage.setItem('fin_ent_data', JSON.stringify(transacoes));
            localStorage.setItem('fin_ent_cats', JSON.stringify(categorias));
        }

        function atualizarDashboard() {
            const filtro = document.getElementById('filtro-periodo').value;
            const hoje = new Date();
            
            // Filtra dados
            let dados = transacoes;
            if (filtro === 'atual') {
                dados = transacoes.filter(t => {
                    const d = new Date(t.data);
                    // Corrige timezone offset simples
                    const dLocal = new Date(d.valueOf() + d.getTimezoneOffset() * 60000);
                    return dLocal.getMonth() === hoje.getMonth() && dLocal.getFullYear() === hoje.getFullYear();
                });
            }

            // Calcula Totais
            let ent = 0, sai = 0, catTotais = {};
            dados.forEach(t => {
                if(t.tipo === 'entrada') ent += t.val;
                else {
                    sai += t.val;
                    catTotais[t.cat] = (catTotais[t.cat] || 0) + t.val;
                }
            });

            // Atualiza DOM
            document.getElementById('dash-saldo').innerText = `R$ ${(ent - sai).toFixed(2)}`;
            document.getElementById('dash-receitas').innerText = `R$ ${ent.toFixed(2)}`;
            document.getElementById('dash-despesas').innerText = `R$ ${sai.toFixed(2)}`;

            renderizarGrafico(catTotais);
            renderizarMetas(catTotais);
            
            // Atualiza tamb√©m as outras abas para garantir sincronia
            renderizarExtrato();
            renderizarConfigCats();
        }

        function renderizarExtrato() {
            const tbody = document.querySelector('#tabela-extrato tbody');
            tbody.innerHTML = '';

            // Ordena por data (mais recente)
            const ordenado = [...transacoes].sort((a,b) => new Date(b.data) - new Date(a.data));

            ordenado.forEach(t => {
                const tr = document.createElement('tr');
                const cor = t.tipo === 'entrada' ? 'var(--secondary)' : 'var(--danger)';
                tr.innerHTML = `
                    <td>${new Date(t.data).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td>
                    <td>${t.desc}</td>
                    <td><span style="background:var(--bg-body); padding:2px 8px; border-radius:4px; font-size:0.85rem;">${t.cat}</span></td>
                    <td style="color:${cor}; font-weight:bold;">R$ ${t.val.toFixed(2)}</td>
                    <td><button class="btn-icon" style="color:var(--text-muted);" onclick="solicitarDelecao(${t.id}, 'transacao')">üóëÔ∏è</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderizarMetas(gastosAtuais) {
            const div = document.getElementById('lista-metas-dash');
            div.innerHTML = '';

            for (let [cat, limite] of Object.entries(categorias)) {
                if(limite <= 0) continue;
                const gasto = gastosAtuais[cat] || 0;
                const pct = Math.min((gasto / limite) * 100, 100);
                let corBarra = 'var(--secondary)';
                if(pct > 75) corBarra = '#f1c40f'; // Amarelo
                if(pct > 95) corBarra = 'var(--danger)'; // Vermelho

                div.innerHTML += `
                    <div>
                        <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px;">
                            <span>${cat}</span>
                            <span>R$ ${gasto.toFixed(0)} / ${limite}</span>
                        </div>
                        <div style="width:100%; background:var(--bg-body); height:8px; border-radius:4px; overflow:hidden;">
                            <div style="width:${pct}%; background:${corBarra}; height:100%; transition: width 0.5s;"></div>
                        </div>
                    </div>
                `;
            }
        }

        function renderizarConfigCats() {
            const div = document.getElementById('config-lista-cats');
            div.innerHTML = '';
            for (let [cat, limite] of Object.entries(categorias)) {
                div.innerHTML += `
                    <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border); align-items:center;">
                        <div>
                            <div style="font-weight:600;">${cat}</div>
                            <div style="font-size:0.85rem; color:var(--text-muted);">Meta: R$ ${limite}</div>
                        </div>
                        <button class="btn-icon" style="color:var(--danger);" onclick="solicitarDelecao('${cat}', 'categoria')">üóëÔ∏è</button>
                    </div>
                `;
            }
        }

        function renderizarGrafico(dados) {
            const ctx = document.getElementById('grafico-rosca').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            const labels = Object.keys(dados);
            const values = Object.values(dados);
            const colors = ['#820ad1', '#00d283', '#ff4757', '#f1c40f', '#3498db', '#9b59b6'];

            if(labels.length === 0) {
                // Gr√°fico vazio placeholder
                chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels:['Sem dados'], datasets:[{data:[1], backgroundColor:['#eee']}] }, options: { maintainAspectRatio:false } });
                return;
            }

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } }
                    }
                }
            });
        }

        function atualizarSelectCategorias() {
            const selects = [document.getElementById('input-categoria')];
            selects.forEach(sel => {
                if(!sel) return;
                sel.innerHTML = '';
                Object.keys(categorias).forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    opt.innerText = cat;
                    sel.appendChild(opt);
                });
            });
        }

        // --- 6. IMPORT/EXPORT ---
        function exportarDados() {
            const dataStr = JSON.stringify({ transacoes, categorias });
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_fincontrol_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importarDados(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.transacoes) transacoes = d.transacoes;
                    if(d.categorias) categorias = d.categorias;
                    salvarTudo();
                    location.reload();
                } catch(err) {
                    alert("Arquivo inv√°lido!");
                }
            };
            reader.readAsText(input.files[0]);
        }
    </script>
</body>
</html>
