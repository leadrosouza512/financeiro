<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinControl v12 Ultimate</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. DESIGN SYSTEM --- */
        :root {
            --primary: #1a73e8; --primary-dark: #0d47a1;
            --accent-green: #28a745; --accent-red: #dc3545; --accent-warning: #ffc107;
            --bg-body: #f0f2f5; --bg-card: #ffffff;
            --text-main: #2c3e50; --text-muted: #6c757d; --border-color: #e9ecef;
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08); --radius: 16px;
        }

        [data-theme="dark"] {
            --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #f8f9fa;
            --text-muted: #adb5bd; --border-color: #333; --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; transition: 0.3s; }
        
        .icon { font-size: 1.2rem; margin-right: 10px; }

        /* --- 2. LAYOUT --- */
        .app-layout { display: flex; height: 100%; display: none; }
        
        #sidebar {
            width: 280px; background: var(--bg-card); display: flex; flex-direction: column;
            border-right: 1px solid var(--border-color); z-index: 2000; transition: 0.3s;
        }
        .brand { padding: 30px 25px; font-size: 1.4rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .menu-list { list-style: none; padding: 0 15px; flex: 1; }
        .menu-link {
            display: flex; align-items: center; padding: 12px 18px; text-decoration: none;
            color: var(--text-muted); border-radius: 12px; font-weight: 500; cursor: pointer; margin-bottom: 5px; transition: 0.2s;
        }
        .menu-link:hover { background: var(--bg-body); color: var(--primary); }
        .menu-link.active { background: rgba(26, 115, 232, 0.1); color: var(--primary); font-weight: 600; }
        
        .user-info { padding: 20px; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px; font-size: 0.9rem; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        header { background: var(--bg-card); padding: 15px 30px; display: none; justify-content: space-between; align-items: center; box-shadow: var(--shadow-md); z-index: 1000; }
        .page-content { flex: 1; overflow-y: auto; padding: 30px; padding-bottom: 80px; }

        /* --- 3. UI COMPONENTS --- */
        .card { background: var(--bg-card); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow-md); margin-bottom: 25px; border: 1px solid var(--border-color); }
        
        /* Dashboard */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { padding: 25px; background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow-md); border-left: 5px solid transparent; border: 1px solid var(--border-color); position: relative;}
        .summary-card::before { content:''; position: absolute; left:0; top:0; bottom:0; width:5px; border-top-left-radius: var(--radius); border-bottom-left-radius: var(--radius); }
        .summary-card.saldo::before { background: var(--primary); }
        .summary-card.receitas::before { background: var(--accent-green); }
        .summary-card.despesas::before { background: var(--accent-red); }
        .summary-val { font-size: 2rem; font-weight: 700; margin-top: 5px; }
        
        /* Tabelas */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 600px; }
        th { text-align: left; color: var(--text-muted); font-weight: 600; padding: 15px; border-bottom: 2px solid var(--border-color); font-size: 0.9rem; }
        td { padding: 15px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        
        /* Forms e Bot√µes */
        .btn { padding: 12px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-icon { background: rgba(0,0,0,0.05); border: none; cursor: pointer; padding: 8px; border-radius: 8px; color: var(--text-muted); }
        
        .form-control { width: 100%; padding: 12px; border: 2px solid var(--border-color); background: var(--bg-body); color: var(--text-main); border-radius: 10px; margin-bottom: 15px; outline: none; }
        .form-control:focus { border-color: var(--primary); background: var(--bg-card); }
        .label { font-weight: 600; margin-bottom: 5px; display: block; font-size: 0.9rem; }

        /* Checkbox Recorr√™ncia */
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding: 10px; background: var(--bg-body); border-radius: 10px; cursor: pointer; }
        .checkbox-wrapper input { width: 20px; height: 20px; cursor: pointer; }

        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-card { background: var(--bg-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-md); text-align: center; width: 90%; max-width: 400px; }

        /* Toasts */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 5000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; background: var(--bg-card); border-left: 5px solid var(--primary); box-shadow: var(--shadow-md); border-radius: 8px; animation: slideIn 0.3s; display: flex; align-items: center; gap: 10px; font-weight: 500; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Mobile */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1500; opacity: 0; visibility: hidden; transition: 0.3s; }
        #overlay.visible { opacity: 1; visibility: visible; }
        .screen { display: none; animation: fadeIn 0.3s; } .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) { 
            #sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); }
            #sidebar.open { transform: translateX(0); }
            header { display: flex; }
            .btn-close-menu { display: block !important; margin-top: 20px; color: var(--accent-red); text-align: center; cursor: pointer; font-weight: 600; }
        }
        .btn-close-menu { display: none; }
        
        .progress-bar-bg { width: 100%; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { height: 100%; border-radius: 3px; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="login-screen">
        <div class="login-card">
            <h1 style="color:var(--primary); margin-bottom:10px;">FinControl v12</h1>
            <p style="color:var(--text-muted);">A Vers√£o Definitiva.</p>
            <br>
            <button class="btn" style="background:white; border:1px solid #ddd; width:100%; display:flex; align-items:center; justify-content:center; gap:10px;" onclick="fazerLogin()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Entrar com Google
            </button>
        </div>
    </div>

    <div class="app-layout" id="app-interface">
        <div id="overlay" onclick="toggleMenu(false)"></div>

        <aside id="sidebar">
            <div class="brand">üöÄ FinControl</div>
            <ul class="menu-list">
                <li><a class="menu-link active" onclick="navegar('dashboard', this)"><span class="icon">üìä</span> Vis√£o Geral</a></li>
                <li><a class="menu-link" onclick="navegar('lancamentos', this)"><span class="icon">üìù</span> Extrato</a></li>
                <li><a class="menu-link" onclick="navegar('adicionar', this)"><span class="icon">‚ûï</span> Novo</a></li>
                <li><a class="menu-link" onclick="navegar('config', this)"><span class="icon">‚öôÔ∏è</span> Configura√ß√µes</a></li>
                <li><a class="menu-link" onclick="alternarTema()"><span class="icon">üåì</span> Tema</a></li>
                <li class="btn-close-menu" onclick="toggleMenu(false)">‚úï Fechar Menu</li>
            </ul>
            <div class="user-info">
                <img id="user-photo" class="user-avatar" src="" alt="">
                <div>
                    <div id="user-name" style="font-weight:600;">Usu√°rio</div>
                    <div onclick="auth.signOut()" style="color:var(--accent-red); cursor:pointer; font-size:0.8rem;">Sair</div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header>
                <strong>Finan√ßas</strong>
                <button onclick="toggleMenu(true)" style="background:none; border:none; font-size:24px;">‚ò∞</button>
            </header>

            <div class="page-content">
                
                <section id="dashboard" class="screen active">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; flex-wrap:wrap; gap:10px;">
                        <div>
                            <h2>Vis√£o Geral</h2>
                            <p style="color:var(--text-muted); font-size:0.9rem;">Selecione o per√≠odo para an√°lise.</p>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="month" id="filtro-data" class="form-control" style="width:auto; margin:0;" onchange="renderizarInterface()">
                            <button class="btn" style="padding:10px;" onclick="limparFiltro()">Todos</button>
                        </div>
                    </div>

                    <div class="summary-grid">
                        <div class="summary-card saldo">
                            <span style="color:var(--text-muted); font-size:0.9rem;">Saldo no Per√≠odo</span>
                            <div class="summary-val" id="dash-saldo">R$ 0,00</div>
                        </div>
                        <div class="summary-card receitas">
                            <span style="color:var(--text-muted); font-size:0.9rem;">Receitas</span>
                            <div class="summary-val" style="color:var(--accent-green)" id="dash-ent">R$ 0,00</div>
                        </div>
                        <div class="summary-card despesas">
                            <span style="color:var(--text-muted); font-size:0.9rem;">Despesas</span>
                            <div class="summary-val" style="color:var(--accent-red)" id="dash-sai">R$ 0,00</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                        <div class="card" style="min-height:350px;">
                            <h3>Gastos por Categoria</h3><br>
                            <div style="height:250px;"><canvas id="grafico-rosca"></canvas></div>
                        </div>

                        <div class="card" style="min-height:350px;">
                            <h3>Progresso das Metas</h3>
                            <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;">Monitoramento em tempo real.</p>
                            <div class="table-container">
                                <table id="tabela-metas">
                                    <thead><tr><th>Categoria</th><th>Gasto</th><th>Meta</th><th>%</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="lancamentos" class="screen">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2>Extrato</h2>
                        <button class="btn btn-primary" onclick="exportarCSV()">üì• Baixar CSV</button>
                    </div>
                    <div class="card table-container">
                        <table id="tabela-extrato"><thead><tr><th>Data</th><th>Desc</th><th>Valor</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table>
                    </div>
                </section>

                <section id="adicionar" class="screen">
                    <h2>Novo Lan√ßamento</h2><br>
                    <div class="card" style="max-width:600px; margin:0 auto;">
                        <form id="form-transacao">
                            <input type="hidden" id="input-id">
                            
                            <label class="label">Tipo</label>
                            <select id="input-tipo" class="form-control"><option value="saida">üí∏ Despesa</option><option value="entrada">üí∞ Receita</option></select>
                            
                            <label class="label">Descri√ß√£o</label>
                            <input type="text" id="input-desc" class="form-control" required placeholder="Ex: Aluguel">
                            
                            <label class="label">Categoria</label>
                            <select id="input-categoria" class="form-control"></select>
                            
                            <label class="label">Valor (R$)</label>
                            <input type="number" step="0.01" id="input-valor" class="form-control" required placeholder="0.00">
                            
                            <label class="label">Data</label>
                            <input type="date" id="input-data" class="form-control" required>

                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="input-recorrente">
                                <span style="font-size:0.9rem;">Despesa Fixa (Repetir todo m√™s)</span>
                            </label>

                            <div style="display:flex; gap:10px;">
                                <button type="submit" class="btn btn-primary" style="flex:1;" id="btn-salvar">Salvar</button>
                                <button type="button" class="btn" style="background:#eee; display:none;" id="btn-cancelar" onclick="resetForm()">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </section>

                <section id="config" class="screen">
                    <h2>Configura√ß√µes</h2><br>
                    <div class="card">
                        <h3>Categorias</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:15px;">Deixe a meta em 0 para n√£o aparecer nos gr√°ficos.</p>
                        <div style="display:flex; gap:10px; padding-bottom:20px;">
                            <input type="text" id="nova-cat-nome" class="form-control" placeholder="Nome" style="margin:0; flex:2;">
                            <input type="number" id="nova-cat-meta" class="form-control" placeholder="Meta" style="margin:0; flex:1;">
                            <button onclick="addCategoriaCloud()" class="btn btn-primary" style="height:48px;">Add</button>
                        </div>
                        <div id="lista-cats-config"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // --- CHAVES FIREBASE (INSIRA AQUI SE PRECISAR TROCAR) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAXU77W9IhtnAlM_vMUEMgM9_WScjEQaVU",
            authDomain: "app-financeiro-c2984.firebaseapp.com",
            projectId: "app-financeiro-c2984",
            storageBucket: "app-financeiro-c2984.firebasestorage.app",
            messagingSenderId: "296730284016",
            appId: "1:296730284016:web:b327a149cf0a7c059ed735",
            measurementId: "G-4XWB5TYSY6"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- ESTADO ---
        let user = null;
        let transacoes = [];
        let categorias = [];
        let chartInstance = null;

        // --- AUTH ---
        auth.onAuthStateChanged((u) => {
            if (u) {
                user = u;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-interface').style.display = 'flex';
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('user-photo').src = user.photoURL;
                initListeners();
                checarRecorrencia(); // Verifica despesas fixas ao logar
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-interface').style.display = 'none';
            }
        });

        function fazerLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => alert(e.message));
        }

        // --- DADOS ---
        function initListeners() {
            // Pega transa√ß√µes
            db.collection('users').doc(user.uid).collection('transacoes').orderBy('data', 'desc')
                .onSnapshot(snap => {
                    transacoes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderizarInterface();
                });

            // Pega categorias
            db.collection('users').doc(user.uid).collection('categorias').orderBy('nome', 'asc')
                .onSnapshot(snap => {
                    categorias = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(categorias.length===0) criarPadrao();
                    renderizarCats();
                });
        }
        
        function criarPadrao() {
            ['Alimenta√ß√£o', 'Transporte', 'Lazer', 'Moradia'].forEach(n => db.collection('users').doc(user.uid).collection('categorias').add({ nome: n, meta: 1000 }));
        }

        // --- RECORR√äNCIA AUTOM√ÅTICA (NOVO!) ---
        function checarRecorrencia() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();

            // Busca transa√ß√µes marcadas como recorrentes na nuvem
            db.collection('users').doc(user.uid).collection('transacoes')
                .where("recorrente", "==", true)
                .get()
                .then(querySnapshot => {
                    querySnapshot.forEach(doc => {
                        const t = doc.data();
                        const dataOriginal = new Date(t.data);
                        
                        // Se a despesa √© de um m√™s anterior E ainda n√£o existe neste m√™s
                        if ((dataOriginal.getMonth() !== mesAtual || dataOriginal.getFullYear() !== anoAtual) && dataOriginal < hoje) {
                            
                            // Verifica duplicidade localmente para evitar spam
                            const jaExiste = transacoes.some(tr => tr.desc === t.desc && tr.val === t.val && new Date(tr.data).getMonth() === mesAtual);
                            
                            if (!jaExiste) {
                                // Clona para o m√™s atual
                                const novaData = new Date();
                                novaData.setDate(dataOriginal.getDate()); // Mant√©m o dia (ex: dia 05)
                                
                                db.collection('users').doc(user.uid).collection('transacoes').add({
                                    ...t,
                                    data: novaData.toISOString().split('T')[0] // Data atualizada
                                });
                                notificar(`Despesa fixa lan√ßada: ${t.desc}`);
                            }
                        }
                    });
                });
        }

        // --- RENDERIZA√á√ÉO ---
        function renderizarInterface() {
            const filtroData = document.getElementById('filtro-data').value; // YYYY-MM
            let dados = transacoes;
            
            // Filtro de Data Avan√ßado
            if (filtroData) {
                const [ano, mes] = filtroData.split('-');
                dados = transacoes.filter(t => {
                    // Ajuste de fuso hor√°rio simples
                    const d = new Date(t.data + "T00:00:00");
                    return d.getMonth() === (parseInt(mes) - 1) && d.getFullYear() === parseInt(ano);
                });
            }

            let ent=0, sai=0, gastosPorCat={};
            const tb = document.querySelector('#tabela-extrato tbody');
            tb.innerHTML = '';

            dados.forEach(t => {
                if(t.tipo === 'entrada') ent += t.val;
                else {
                    sai += t.val;
                    gastosPorCat[t.cat] = (gastosPorCat[t.cat] || 0) + t.val;
                }
                tb.innerHTML += `<tr>
                    <td>${new Date(t.data+"T00:00:00").toLocaleDateString()}<br><small>${t.cat}</small></td>
                    <td>${t.desc} ${t.recorrente ? 'üîÑ' : ''}</td>
                    <td style="color:${t.tipo==='entrada'?'var(--accent-green)':'var(--accent-red)'}">R$ ${t.val.toFixed(2)}</td>
                    <td><button onclick="editarItem('${t.id}')" class="btn-icon">‚úèÔ∏è</button><button onclick="deletarItem('transacoes','${t.id}')" class="btn-icon" style="color:red">üóëÔ∏è</button></td>
                </tr>`;
            });

            document.getElementById('dash-saldo').innerText = `R$ ${(ent-sai).toFixed(2)}`;
            document.getElementById('dash-ent').innerText = `R$ ${ent.toFixed(2)}`;
            document.getElementById('dash-sai').innerText = `R$ ${sai.toFixed(2)}`;

            renderizarGrafico(gastosPorCat);
            renderizarTabelaMetas(gastosPorCat);
        }

        function renderizarTabelaMetas(gastosAtuais) {
            const tbody = document.querySelector('#tabela-metas tbody');
            tbody.innerHTML = '';
            
            const catsComMeta = categorias.filter(c => c.meta && c.meta > 0);
            if(catsComMeta.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:gray;">Sem metas configuradas.</td></tr>'; return;
            }

            catsComMeta.forEach(c => {
                const gasto = gastosAtuais[c.nome] || 0;
                const pct = Math.min((gasto/c.meta)*100, 100);
                let cor = 'var(--primary)';
                if(pct > 80) cor = 'var(--accent-warning)';
                if(pct > 100) cor = 'var(--accent-red)';

                tbody.innerHTML += `<tr>
                    <td><b>${c.nome}</b></td>
                    <td>R$ ${gasto.toFixed(0)}</td>
                    <td style="color:gray">R$ ${c.meta}</td>
                    <td><div style="font-size:0.8rem;">${pct.toFixed(0)}%</div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%; background:${cor};"></div></div></td>
                </tr>`;
            });
        }

        function renderizarCats() {
            const div = document.getElementById('lista-cats-config');
            const sel = document.getElementById('input-categoria');
            div.innerHTML = ''; sel.innerHTML = '';

            categorias.forEach(c => {
                const metaTxt = (c.meta > 0) ? `Meta: R$ ${c.meta}` : `(Apenas Etiqueta)`;
                div.innerHTML += `<div style="padding:15px; border-bottom:1px solid #e9ecef; display:flex; justify-content:space-between;">
                    <div><b>${c.nome}</b> <small style="color:gray; display:block;">${metaTxt}</small></div>
                    <button onclick="deletarItem('categorias','${c.id}')" class="btn-icon" style="color:red;">üóëÔ∏è</button>
                </div>`;
                sel.innerHTML += `<option value="${c.nome}">${c.nome}</option>`;
            });
        }

        function renderizarGrafico(dados) {
            const ctx = document.getElementById('grafico-rosca').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            const labels = Object.keys(dados);
            const vals = Object.values(dados);
            const colors = ['#1a73e8','#28a745','#f1c40f','#e83e8c','#6f42c1', '#fd7e14'];
            
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels.length?labels:['Vazio'], datasets: [{ data: vals.length?vals:[1], backgroundColor: labels.length?colors:['#eee'], borderWidth:0 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position:'right' } } }
            });
        }

        // --- A√á√ïES ---
        function addCategoriaCloud() {
            const nome = document.getElementById('nova-cat-nome').value;
            let meta = document.getElementById('nova-cat-meta').value;
            if(nome) {
                meta = meta ? parseFloat(meta) : 0;
                db.collection('users').doc(user.uid).collection('categorias').add({ nome, meta });
                document.getElementById('nova-cat-nome').value = '';
                document.getElementById('nova-cat-meta').value = '';
                notificar("Categoria criada!");
            }
        }

        document.getElementById('form-transacao').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-salvar');
            const id = document.getElementById('input-id').value;
            btn.innerText = "Salvando..."; btn.disabled = true;

            const dados = {
                tipo: document.getElementById('input-tipo').value,
                desc: document.getElementById('input-desc').value,
                cat: document.getElementById('input-categoria').value,
                val: parseFloat(document.getElementById('input-valor').value),
                data: document.getElementById('input-data').value,
                recorrente: document.getElementById('input-recorrente').checked
            };

            const promessa = id ? db.collection('users').doc(user.uid).collection('transacoes').doc(id).update(dados)
                                : db.collection('users').doc(user.uid).collection('transacoes').add(dados);

            promessa.then(() => {
                resetForm();
                notificar("Salvo com sucesso!");
                navegar('dashboard');
            }).catch(e => alert(e)).finally(() => { btn.innerText = "Salvar"; btn.disabled = false; });
        });

        function deletarItem(col, id) {
            if(confirm("Excluir item?")) db.collection('users').doc(user.uid).collection(col).doc(id).delete();
        }

        function editarItem(id) {
            const t = transacoes.find(x => x.id === id);
            if(t) {
                document.getElementById('input-id').value = id;
                document.getElementById('input-tipo').value = t.tipo;
                document.getElementById('input-desc').value = t.desc;
                document.getElementById('input-categoria').value = t.cat;
                document.getElementById('input-valor').value = t.val;
                document.getElementById('input-data').value = t.data;
                document.getElementById('input-recorrente').checked = t.recorrente || false;
                document.getElementById('btn-salvar').innerText = "Atualizar";
                document.getElementById('btn-cancelar').style.display = 'block';
                navegar('adicionar');
            }
        }

        function resetForm() {
            document.getElementById('form-transacao').reset();
            document.getElementById('input-id').value = '';
            document.getElementById('input-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('btn-salvar').innerText = "Salvar";
            document.getElementById('btn-cancelar').style.display = 'none';
        }

        // --- UTILS & EXPORT ---
        function exportarCSV() {
            let csv = "Data,Descricao,Categoria,Tipo,Valor\n";
            transacoes.forEach(t => {
                csv += `${t.data},"${t.desc}","${t.cat}",${t.tipo},${t.val}\n`;
            });
            const link = document.createElement("a");
            link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            link.download = "relatorio_fincontrol.csv";
            link.click();
        }

        function limparFiltro() {
            document.getElementById('filtro-data').value = '';
            renderizarInterface();
        }

        function notificar(msg) {
            const t = document.createElement('div'); t.className = 'toast';
            t.innerText = `‚úÖ ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(()=>t.remove(), 3000);
        }

        function navegar(tela, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(tela).classList.add('active');
            if(el) { document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active')); el.classList.add('active'); }
            toggleMenu(false);
        }
        function toggleMenu(s) {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('overlay');
            if(s){ sb.classList.add('open'); ov.classList.add('visible'); } else { sb.classList.remove('open'); ov.classList.remove('visible'); }
        }
        function alternarTema() {
            const b = document.body;
            if(b.hasAttribute('data-theme')) { b.removeAttribute('data-theme'); localStorage.setItem('theme','light'); }
            else { b.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); }
        }

        // Auto Init
        const hojeISO = new Date().toISOString().split('T')[0];
        document.getElementById('input-data').value = hojeISO;
        // Seta filtro inicial para o m√™s atual
        document.getElementById('filtro-data').value = hojeISO.slice(0, 7); 
        
        if(localStorage.getItem('theme')==='dark') document.body.setAttribute('data-theme','dark');
    </script>
</body>
</html>
